---
- hosts: all
  become: yes
  
  vars:
    vm_name: debian
    snapshot_name: fresh_install
    
  tasks:
    - name: Ensure snapshot exsists.
      block:
        - name: List snapshots.
          command: "virsh snapshot-list {{ vm_name }}"
          register: snapshot_list_cmd
          
        - name: Ensure snapshot exsists.
          command: "virsh snapshot-create-as {{ vm_name }} --name {{ snapshot_name }} --atomic"
          when: snapshot_name not in snapshot_list_cmd.stdout
